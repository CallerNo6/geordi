{%- macro json_pp(json_data, dictarray) -%}
    <dl>
    {%- for item in dictarray(json_data) recursive -%}
        {%- if item is mapping and item.keys() == ['k', 'v'] %}
            <dt class="expander block-expander closed"><i class="icon"></i> <span class="clicker">{{ item.k }}</span></dt>
            <dd class="collapse">{{ json_looper(item.v, loop, dictarray) }}</dd>
        {%- else %}
            <li class="expander block-expander closed" style="clear: left"><span class="clicker"><code>[{{ loop.index0 }}]</code></span>
                <div class="collapse li">{{ json_looper(item, loop, dictarray) }}</div>
            </li>
        {%- endif -%}
    {%- endfor -%}
    </dl>
{%- endmacro -%}

{%- macro json_looper(item, loop, dictarray) -%}
    {%- if item is mapping -%}
        <dl>{{ loop(dictarray(item)) }}</dl>
    {%- elif item is iterable and item is not string -%}
        <ul>{{ loop(item) }}</ul>
    {%- else -%} 
        <span class="plain-text">{{ item }}</span>
    {%- endif -%}
{%- endmacro -%}

{%- macro expander_js() -%}
<script>
  function changeRegion($region) {
    $region.children('div.li').add($region.next('dd'))
              [$region.hasClass('closed') ? 'removeClass' : 'addClass']('collapse')
           .end().end()

           .toggleClass('closed open');
  }

  $('.block-expander span.clicker').click(function(event) {
    event.stopPropagation();
    var $this = $(this).parent('.block-expander');
    changeRegion($this);
    if (event.altKey) {
        $this.children('div.li').add($this.next('dd'))
             .find('.block-expander.' + ($this.hasClass('open') ? 'closed' : 'open'))
             .each(function() { changeRegion($(this)) });
    }
  });
</script>
{%- endmacro -%}
