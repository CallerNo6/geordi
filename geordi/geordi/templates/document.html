{%- from "json_pp.html" import json_pp, expander_js -%}
{% extends "layout.html" %}
{% block title %}{{ data._index }} - {{ data._id }}{% endblock %}

{% block content %}
<p>
This is <code>{{ data._id }}</code> from the index <code>{{ data._index }}</code>.
</p>

<p>In the JSON Source view, alt-click will open and close full subtrees.</p>

{% if mapping %}
{{ section_links('mapping') }}
<h2 id="mapping">Extracted Information</h2>
<p>This mapping was generated using version <code>{{ mapping.version }}</code> of the <code>{{ data._index }}</code> mapping. For further details, or to make suggestions, please see <a href="{{code_url}}">the mapping code</a>.</p>
<h3>Summary</h3>
<table class="zebra"><tbody>
    {% for title in mapping.release.title -%}
    <tr><th>Title{% if mapping.release.title | length > 1 %} (alternate){% endif %}:</th><td>{{ title }}{%- if loop.first %} {{ link_opener('item', data._id, data) }}{%- endif-%}</td></tr>
    {%- endfor %}
    <tr><th>Artist:</th>
        <td>{% for artist in mapping.release.artist -%}
              {%- if artist.subitem -%}
              <a class="subitem-opener" data-subitem="{{artist.subitem}}" href="#li-subitem-{{artist.subitem}}">{{artist.name}}</a>
              {{ link_opener('subitem', artist.subitem, subitems[artist.subitem]) }}
              {{ subitem_search(data._index, g.re.split('-', artist.subitem)[0], g.re.split('-', artist.subitem)[1]) }}
              {%- else -%}{{artist.name}}{%- endif -%}
              {% if loop.revindex > 2 %}, {% elif loop.revindex == 2 %} and {% endif -%}
            {%- endfor %}{% if mapping.release.artist | length > 1 %} <small>({{mapping.release.artist | length}} artists)</small>{% endif -%}
    </td></tr>
    {% for date in mapping.release.date -%}
    <tr><th>Date{% if mapping.release.date | length > 1 %} (alternate){% endif %}:</th><td>{{ date }}</td></tr>
    {%- endfor %}
    {% for label in mapping.release.label -%}
    <tr><th>Label:</th>
        <td>{%- if label.subitem -%}
              <a class="subitem-opener" data-subitem="{{label.subitem}}" href="#li-subitem-{{label.subitem}}">{{label.name}}</a>
              {{ link_opener('subitem', label.subitem, subitems[label.subitem]) }}
              {{ subitem_search(data._index, g.re.split('-', label.subitem)[0], g.re.split('-', label.subitem)[1]) }}
              {%- else -%}{{label.name}}{%- endif -%}
    </td></tr>
    {%- endfor %}
    {% for catalog_number in mapping.release.catalog_number -%}
    <tr><th>Catalog Number:</th><td>{{ catalog_number }}</td></tr>
    {%- endfor %}
    <tr><th>Tracks:</th><td>{{ mapping.release.tracks | length }}</td></tr>
</tbody></table>
<h3>Tracklist</h3>
<table class="zebra">
<thead>
{%- set col = 5 -%}
<tr>
  {%- if mapoptions.mediums %}<th>Medium</th>{% set col = col + 1 %}{% endif -%}
  <th>#</th>
  {%- if mapoptions.totaltracks %}<th>Total</th>{% set col = col + 1 %}{% endif -%}
  <th>Title</th><th>Artist</th><th>Length</th>
  {%- if mapoptions.acoustid %}<th>AcoustID</th>{% set col = col + 1 %}{% endif -%}
  <th></th>
</tr>
</thead>
<tbody>
{%- set medium = none -%}
{%- for track in mapping.release.tracks -%}
{%- if track.medium | length == 1 and medium != track.medium[0] and not loop.first %}<tr><th class="mediumheader" colspan={{col}}><hr /></th></tr>{% endif -%}
{%- if track.medium | length == 1 %}{% set medium = track.medium[0] %}{% endif %}
<tr>
  {%- if mapoptions.mediums -%}
  <td>
    {%- for medium_number in track.medium %}{{ medium_number }}{% if not loop.last %}<br />{% endif %}{% endfor -%}
  </td>
  {%- endif -%}
  <td>
    {%- for tnum in track.number -%}{{ tnum }}{% if not loop.last %}/{% endif %}{% endfor -%}
  </td>
  {%- if mapoptions.totaltracks -%}
  <td>
    {%- for totaltracks in track.totaltracks %}{{ totaltracks }}{% if not loop.last %}<br />{% endif %}{% endfor -%}
  </td>
  {%- endif -%}
  <td>{% for title in track.title %}{{ title }}{% if not loop.last %}<br />{% endif %}{% endfor %}</td>
  <td>{% for artist in track.artist -%}
              {%- if artist.subitem -%}
              <a class="subitem-opener" data-subitem="{{artist.subitem}}" href="#li-subitem-{{artist.subitem}}">{{artist.name}}</a>
              {{ link_opener('subitem', artist.subitem, subitems[artist.subitem]) }}
              {{ subitem_search(data._index, g.re.split('-', artist.subitem)[0], g.re.split('-', artist.subitem)[1]) }}
              {%- else -%}{{artist.name}}{%- endif -%}
              {% if loop.revindex > 2 %}, {% elif loop.revindex == 2 %} and {% endif -%}
            {%- endfor %}{% if track.artist | length > 1 %} <small>({{track.artist | length}} artists)</small>{% endif -%}
  </td>
  <td>{% for length in track.length_formatted %}{{ length }}{% if not loop.last %}<br />{% endif %}{% endfor %}</td>
  {%- if mapoptions.acoustid -%}
  <td>
    {%- for acoustid in track.acoustid %}<a href="https://acoustid.org/track/{{ acoustid }}">{{ acoustid[:4] }}â€¦{{ acoustid[-4:]}}</a>{% if not loop.last %}<br />{% endif %}{% endfor -%}
  </td>
  {%- endif -%}
  <td>{% if track.subitem %} <small>(<a class="subitem-opener" data-subitem="{{ track.subitem }}" href="#li-subitem-{{ track.subitem }}">subitem</a>) 
      {{ link_opener('subitem', track.subitem, subitems[track.subitem]) }}
      {{ subitem_search(data._index, g.re.split('-', track.subitem)[0], g.re.split('-', track.subitem)[1]) }}
    </small>{% endif %}
  </td>
</tr>
{%- endfor -%}
</tbody></table>
{% endif %}

{{ section_links('link') }}
<h2 id="link">Link to MusicBrainz</h2>
<dl class="clearfix">
<dt>Whole Item</dt>
<dd>{{ current_match_span(data, 'item') }}
    {{ linker_content('item-linker-content', 'item-linker-content', 'Match Item', none, 'item', data._id, data._index, data) }}
</dd>
{%- for (link_type_id, link_type) in g.link_types[data._index].iteritems() if not link_type_id == 'version' -%}
<dt>{{ link_type.name }}</dt>
<dd><ul id="ul-subitem-{{link_type_id}}">
{%- set link_id = link_type_id -%}
{%- for link in data._source._geordi.links.links[link_type_id] %}
  {%- set subitem_id = link_id | string + '-' + link[link_type.key] | string -%}
  <li style="clear:both" class="expander block-expander closed" id="li-subitem-{{ subitem_id }}"><span class="clicker"><code>[{{ link[link_type.key] }}]</code></span>
    {{ current_match_span(subitems[subitem_id], 'subitem', subitem_id) }}
    {{ subitem_search(data._index, link[link_type.key], link_id) }}
    {{ linker_content('subitem-linker-content', 'subitem-linker-content-' + subitem_id | string, 'Match ' + subitem_id | string, link, 'subitem', subitem_id, data._index, subitems[subitem_id]) }}
    <div class="li collapse">
    {{ json_pp(link, g.dictarray) }}
    </div>
  </li>
{% endfor -%}
</ul></dd>
{%- endfor -%}
</dl>

{{ section_links('json-source') }}
<h2 id="json-source">JSON Source</h2>
<div>{{ json_pp(data._source, g.dictarray) }}</div>
{% endblock %}

{%- macro section_links(section) -%}
<div class="section-links"><small>Other sections:
  {% if section != 'mapping' %}<a href="#mapping">[Extracted Information]</a>{% endif %}
  {% if section != 'link' %}<a href="#link">[Link to MusicBrainz]</a>{% endif %}
  {% if section != 'json-source' %}<a href="#json-source">[JSON Source]</a></small>{% endif %}
</div>
{%- endmacro -%}

{%- macro current_match_span(data, linker_type, id) -%}
{%- if data and data._source._geordi and data._source._geordi.matchings.current_matching %}
{%- set current_matching = data._source._geordi.matchings.current_matching -%}
{%- endif %}
<span class="current-match{% if current_matching and current_matching.auto %} auto{% endif %}">
    {%- if current_matching %}
      {{ match_span(current_matching) }}
    {%- endif %}
    {{ link_opener(linker_type, id, data, 1) }}
</span>
{%- endmacro -%}

{%- macro link_opener(linker_type, id, data, verbose) -%}
{%- if data and data._source._geordi and data._source._geordi.matchings.current_matching -%}
  {%- set matched = true -%}
  {%- set auto = data._source._geordi.matchings.current_matching.auto -%}
{%- endif -%}
<a class="{{ linker_type }}-linker
          {%- if verbose %} verbose{% endif %}
          {%- if matched %} matched{% endif %}
          {%- if auto %} auto{% endif %}"
      {% if id %}data-{{linker_type}}="{{id}}" {% endif %}href="#">
      {%- if verbose %}<small>{% if matched %}re{% endif %}link</small> {% endif -%}
  <img src="/static/images/link.png" alt="{% if matched %}re{% endif %}link" /></a>
{%- endmacro -%}

{%- macro linker_content(class, id, title, json, type, item, index, matches_json) -%}
<div id="{{ id }}" class="{{ class }}">
  <h3>{{ title }}</h3>
  <dl>{%- if matches_json and matches_json._source._geordi -%}
        {%- set matchings = matches_json._source._geordi.matchings -%}
        {%- set current_matching = matchings.current_matching -%}
        {%- if matchings.matchings | length > 0 -%}
          <dt class="expander block-expander closed"><i class="icon"></i><span class="clicker">Human Matches</span></dt>
          <dd class="collapse">{% for match in matchings.matchings %}{{ match_span(match, true) }}{% if not loop.last %}<br />{% endif %}{% endfor %}</dd>
        {%- endif -%}
        {%- if matchings.auto_matchings | length > 0 -%}
          <dt class="expander block-expander closed"><i class="icon"></i><span class="clicker">Automatic Matches</span></dt>
          <dd class="collapse">{% for match in matchings.auto_matchings %}{{ match_span(match, true) }}{% if not loop.last %}<br />{% endif %}{% endfor %}</dd>
        {%- endif -%}
      {%- else -%}{%- set current_matching = none -%}
      {%- endif -%}
      {%- if json -%}
        <dt class="expander block-expander closed"><i class="icon"></i><span class="clicker">JSON</span></dt>
        <dd class="collapse">{{ json_pp(json, g.dictarray) }}</dd>
      {%- endif -%}

      <dt class="expander block-expander open"><i class="icon"></i><span class="clicker">Match</span></dt>
      <dd class="match-dd"><div>
        <form class="match-form" id="match-{{type}}-{{item}}" action="/api/match{{type}}/{{ index }}/{{ item }}" method="get">
          <select name="type">
            <option{% if current_matching.type == 'release' %} selected="selected"{% endif %}>release</option>
            <option{% if current_matching.type == 'release-group' %} selected="selected"{% endif %}>release-group</option>
            <option{% if current_matching.type == 'recording' %} selected="selected"{% endif %}>recording</option>
            <option{% if current_matching.type == 'work' %} selected="selected"{% endif %}>work</option>
            <option{% if current_matching.type == 'artist' %} selected="selected"{% endif %}>artist</option>
            <option{% if current_matching.type == 'label' %} selected="selected"{% endif %}>label</option>
          </select>
          <textarea name="mbids" placeholder="MBIDs, comma separated">
          {%- if current_matching.mbid | length > 0 -%}{{ g.comma_only_list(current_matching.mbid) }}{%- endif -%}
          </textarea>
          <input type="submit" class="btn primary" value="Match" />
        </form>
        {% if current_matching -%}<div class="current-match">Current match: {{ match_span(current_matching) }}
          <form class="unmatch-form" action="/api/match{{type}}/{{index}}/{{item}}" method="get"><input type="submit" value="Unmatch" /><input type="hidden" name="unmatch" value="true" /></form></div>
        {%- endif %}
        <div class="response"></div>
      </div></dd>
  </dl>
</div>
{%- endmacro -%}

{% block js %}
{{ expander_js() }}
<script src="/static/jquery/jquery.simplemodal.1.4.3.min.js"></script>
<script>geordi.current_index = '{{data._index}}';</script>
<script src="/static/scripts/matching.js"></script>
{% endblock %}
